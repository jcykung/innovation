import React, { useState, useRef, useEffect } from 'react';
import { Info } from 'lucide-react';

const RedshiftDemo = () => {
  const [galaxyPosition, setGalaxyPosition] = useState(180);
  const [isDragging, setIsDragging] = useState(false);
  const containerRef = useRef(null);
  const dragStateRef = useRef({ isDragging: false, minDistance: 100, maxDistance: 900 });
  
  const earthPosition = 40;
  const restPosition = 180;
  
  // Calculate bounds based on container
  useEffect(() => {
    if (containerRef.current) {
      const containerWidth = containerRef.current.offsetWidth;
      const newMaxDistance = containerWidth - 60;
      dragStateRef.current.maxDistance = newMaxDistance;
    }
  }, []);
  
  // Handle window resize
  useEffect(() => {
    const handleResize = () => {
      if (containerRef.current) {
        const containerWidth = containerRef.current.offsetWidth;
        const newMaxDistance = containerWidth - 60;
        dragStateRef.current.maxDistance = newMaxDistance;
        
        // Keep galaxy in bounds
        setGalaxyPosition(prev => Math.min(prev, newMaxDistance));
      }
    };
    
    window.addEventListener('resize', handleResize);
    handleResize(); // Call once on mount
    return () => window.removeEventListener('resize', handleResize);
  }, []);
  
  const maxDistance = dragStateRef.current.maxDistance;
  const minDistance = dragStateRef.current.minDistance;
  
  const displacement = galaxyPosition - restPosition;
  const maxDisplacement = maxDistance - restPosition;
  const velocity = (displacement / maxDisplacement) * 0.7;
  const redshiftFactor = 1 + velocity;
  
  const baseWavelength = 656.3;
  const shiftedWavelength = baseWavelength * redshiftFactor;
  
  const wavelengthToColor = (wavelength) => {
    let r, g, b;
    if (wavelength >= 380 && wavelength < 440) {
      r = -(wavelength - 440) / (440 - 380);
      g = 0;
      b = 1;
    } else if (wavelength >= 440 && wavelength < 490) {
      r = 0;
      g = (wavelength - 440) / (490 - 440);
      b = 1;
    } else if (wavelength >= 490 && wavelength < 510) {
      r = 0;
      g = 1;
      b = -(wavelength - 510) / (510 - 490);
    } else if (wavelength >= 510 && wavelength < 580) {
      r = (wavelength - 510) / (580 - 510);
      g = 1;
      b = 0;
    } else if (wavelength >= 580 && wavelength < 645) {
      r = 1;
      g = -(wavelength - 645) / (645 - 580);
      b = 0;
    } else if (wavelength >= 645 && wavelength <= 780) {
      r = 1;
      g = 0;
      b = 0;
    } else {
      r = 1;
      g = 0;
      b = 0;
    }
    
    return `rgb(${Math.round(r * 255)}, ${Math.round(g * 255)}, ${Math.round(b * 255)})`;
  };
  
  const lightColor = wavelengthToColor(shiftedWavelength);
  
  const absorptionLines = [
    { name: 'H-α', wavelength: 656.3 },
    { name: 'H-β', wavelength: 486.1 },
    { name: 'H-γ', wavelength: 434.0 },
    { name: 'Ca II K', wavelength: 393.4 },
    { name: 'Ca II H', wavelength: 396.8 },
  ];
  
  const updatePosition = (clientX) => {
    if (containerRef.current) {
      const rect = containerRef.current.getBoundingClientRect();
      const x = clientX - rect.left;
      const newPosition = Math.max(minDistance, Math.min(dragStateRef.current.maxDistance, x));
      setGalaxyPosition(newPosition);
    }
  };
  
  useEffect(() => {
    const handleMouseMove = (e) => {
      if (dragStateRef.current.isDragging) {
        updatePosition(e.clientX);
      }
    };
    
    const handleTouchMove = (e) => {
      if (dragStateRef.current.isDragging && e.touches[0]) {
        updatePosition(e.touches[0].clientX);
      }
    };
    
    const handleEnd = () => {
      dragStateRef.current.isDragging = false;
      setIsDragging(false);
    };
    
    window.addEventListener('mousemove', handleMouseMove);
    window.addEventListener('mouseup', handleEnd);
    window.addEventListener('touchmove', handleTouchMove);
    window.addEventListener('touchend', handleEnd);
    
    return () => {
      window.removeEventListener('mousemove', handleMouseMove);
      window.removeEventListener('mouseup', handleEnd);
      window.removeEventListener('touchmove', handleTouchMove);
      window.removeEventListener('touchend', handleEnd);
    };
  }, [minDistance]);
  
  const handleStart = (e) => {
    dragStateRef.current.isDragging = true;
    setIsDragging(true);
    if (e.touches) {
      e.preventDefault();
    }
  };
  
  return (
    <div className="w-full min-h-screen bg-gray-900 text-white p-4 md:p-6 overflow-auto">
      <div className="max-w-7xl mx-auto flex flex-col">
        <h1 className="text-2xl md:text-3xl font-bold mb-2">Redshift Interactive</h1>
        <p className="text-gray-400 mb-4 md:mb-6 text-sm md:text-base">Drag the galaxy away from Earth to see redshift in action</p>
        
        <div className="flex flex-col lg:flex-row gap-4 md:gap-6">
          <div className="flex-1 flex flex-col gap-4 md:gap-6">
            <div 
              ref={containerRef}
              className="relative bg-black rounded-lg border border-gray-700 h-48 md:h-64 overflow-hidden"
              style={{
                backgroundImage: 'radial-gradient(white 1px, transparent 1px)',
                backgroundSize: '50px 50px',
                backgroundPosition: '0 0, 25px 25px'
              }}
            >
              <div className="absolute top-1/2 transform -translate-y-1/2" style={{ left: `${earthPosition}px` }}>
                <div className="w-12 h-12 md:w-16 md:h-16 rounded-full bg-blue-500 border-2 border-blue-300 flex items-center justify-center shadow-lg">
                  <span className="text-xs font-bold">Earth</span>
                </div>
              </div>
              
              <svg className="absolute inset-0 w-full h-full pointer-events-none">
                <defs>
                  <linearGradient id="lightGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style={{ stopColor: lightColor, stopOpacity: 0.8 }} />
                    <stop offset="100%" style={{ stopColor: '#60a5fa', stopOpacity: 0.8 }} />
                  </linearGradient>
                </defs>
                {(() => {
                  const earthRadius = window.innerWidth < 768 ? 24 : 32; // Half of Earth's width
                  const startX = galaxyPosition;
                  const endX = earthPosition + earthRadius; // Start from right edge of Earth
                  const centerY = 96;
                  const totalDistance = startX - endX;
                  const baseWL = 20;
                  const wavelength = baseWL * redshiftFactor;
                  const amplitude = 15;
                  const numWaves = Math.floor(totalDistance / wavelength);
                  
                  let pathData = `M ${startX} ${centerY}`;
                  
                  for (let i = 0; i < numWaves; i++) {
                    const x = startX - (i * wavelength);
                    const x1 = x - wavelength / 4;
                    const x2 = x - (3 * wavelength) / 4;
                    const xNext = x - wavelength;
                    
                    // Stop drawing if we reach the edge of Earth
                    if (xNext < endX) break;
                    
                    pathData += ` Q ${x1} ${centerY - amplitude}, ${x - wavelength/2} ${centerY}`;
                    pathData += ` Q ${x2} ${centerY + amplitude}, ${xNext} ${centerY}`;
                  }
                  
                  return (
                    <path
                      d={pathData}
                      stroke="url(#lightGradient)"
                      strokeWidth="2.5"
                      fill="none"
                      strokeLinecap="round"
                    />
                  );
                })()}
              </svg>
              
              <div 
                className="absolute top-1/2 transform -translate-y-1/2 cursor-grab active:cursor-grabbing touch-none"
                style={{ left: `${galaxyPosition - 24}px` }}
                onMouseDown={handleStart}
                onTouchStart={handleStart}
              >
                <div className="relative">
                  <div 
                    className="w-10 h-10 md:w-12 md:h-12 rounded-full border-2 shadow-lg"
                    style={{ 
                      backgroundColor: lightColor,
                      borderColor: lightColor,
                      filter: 'brightness(1.2)'
                    }}
                  />
                  <div className="absolute inset-0 rounded-full animate-ping opacity-20"
                    style={{ backgroundColor: lightColor }}
                  />
                  <span className="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-xs whitespace-nowrap">
                    Galaxy
                  </span>
                </div>
              </div>
            </div>
            
            <div className="lg:hidden bg-gray-800 rounded-lg border border-gray-700 p-3">
              <div className="grid grid-cols-2 gap-3 text-sm">
                <div className="bg-gray-900 p-2 rounded">
                  <div className="text-xs text-gray-400">Velocity</div>
                  <div className="text-lg font-bold">{(velocity * 100).toFixed(1)}%c</div>
                </div>
                
                <div className="bg-gray-900 p-2 rounded">
                  <div className="text-xs text-gray-400">Redshift (z)</div>
                  <div className="text-lg font-bold">{(redshiftFactor - 1).toFixed(3)}</div>
                </div>
                
                <div className="bg-gray-900 p-2 rounded">
                  <div className="text-xs text-gray-400">H-α λ</div>
                  <div className="text-lg font-bold">{shiftedWavelength.toFixed(1)} nm</div>
                </div>
                
                <div className="bg-gray-900 p-2 rounded">
                  <div className="text-xs text-gray-400">Shift</div>
                  <div className="flex items-center gap-2 mt-1">
                    <div 
                      className="w-6 h-6 rounded border border-gray-600"
                      style={{ backgroundColor: lightColor }}
                    />
                    <span className="text-xs">
                      {velocity > 0.02 ? 'Red Shift' : velocity < -0.02 ? 'Blue Shift' : 'No Shift'}
                    </span>
                  </div>
                </div>
              </div>
            </div>
            
            <div className="bg-gray-800 rounded-lg border border-gray-700 p-3 md:p-4 min-h-[300px]">
              <h3 className="text-base md:text-lg font-semibold mb-3">Absorption Spectrum (Fraunhofer Lines)</h3>
              <div className="relative h-64 md:h-full">
                <div className="absolute left-0 right-0 top-12 h-20 md:h-24 rounded"
                  style={{
                    background: 'linear-gradient(to right, #8b00ff, #0000ff, #00ffff, #00ff00, #ffff00, #ff7f00, #ff0000)'
                  }}
                />
                
                <div className="absolute left-0 right-0 top-0 flex justify-between text-xs text-gray-400">
                  <span>380 nm</span>
                  <span className="hidden sm:inline">500 nm</span>
                  <span className="hidden sm:inline">600 nm</span>
                  <span>780 nm</span>
                </div>
                
                {absorptionLines.map((line, i) => {
                  const position = ((line.wavelength - 380) / (780 - 380)) * 100;
                  return (
                    <div
                      key={`original-${i}`}
                      className="absolute top-12 w-1 h-20 md:h-24 bg-gray-600 opacity-30"
                      style={{ left: `${position}%` }}
                    />
                  );
                })}
                
                {absorptionLines.map((line, i) => {
                  const shiftedWL = line.wavelength * redshiftFactor;
                  const position = ((shiftedWL - 380) / (780 - 380)) * 100;
                  
                  if (position < 0 || position > 100) return null;
                  
                  return (
                    <div key={i} className="absolute" style={{ left: `${position}%` }}>
                      <div className="absolute top-12 w-1.5 h-20 md:h-24 bg-black" />
                      <div className="absolute top-36 md:top-40 transform -translate-x-1/2 text-xs text-center">
                        <div className="font-semibold">{line.name}</div>
                        <div className="text-gray-400 text-[10px] md:text-xs">{shiftedWL.toFixed(1)} nm</div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
          
          <div className="hidden lg:block w-72 bg-gray-800 rounded-lg border border-gray-700 p-4 space-y-4">
            <div className="flex items-center gap-2 text-blue-400">
              <Info size={20} />
              <h3 className="font-semibold">Measurements</h3>
            </div>
            
            <div className="space-y-3">
              <div className="bg-gray-900 p-3 rounded">
                <div className="text-sm text-gray-400">Recession Velocity</div>
                <div className="text-2xl font-bold">{(velocity * 100).toFixed(1)}%</div>
                <div className="text-xs text-gray-500">of speed of light</div>
              </div>
              
              <div className="bg-gray-900 p-3 rounded">
                <div className="text-sm text-gray-400">Redshift Factor (z)</div>
                <div className="text-2xl font-bold">{(redshiftFactor - 1).toFixed(3)}</div>
              </div>
              
              <div className="bg-gray-900 p-3 rounded">
                <div className="text-sm text-gray-400">H-α Wavelength</div>
                <div className="text-xl font-bold">{shiftedWavelength.toFixed(1)} nm</div>
                <div className="text-xs text-gray-500">Original: {baseWavelength} nm</div>
              </div>
              
              <div className="bg-gray-900 p-3 rounded">
                <div className="text-sm text-gray-400">Shift</div>
                <div className="flex items-center gap-2 mt-2">
                  <div 
                    className="w-8 h-8 rounded border border-gray-600"
                    style={{ backgroundColor: lightColor }}
                  />
                  <span className="text-sm">
                    {velocity > 0.02 ? 'Red Shift' : velocity < -0.02 ? 'Blue Shift' : 'No Shift'}
                  </span>
                </div>
              </div>
            </div>
            
            <div className="border-t border-gray-700 pt-4 text-sm text-gray-400">
              <p className="mb-2"><strong className="text-white">How it works:</strong></p>
              <p>As galaxies move away from us, the light they emit stretches to longer wavelengths. This shifts absorption lines toward the red end of the spectrum, revealing the universe's expansion.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default RedshiftDemo;